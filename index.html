<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Map with Clustering Toggle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/csv2geojson@latest/csv2geojson.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster.layersupport@2.0.0/dist/leaflet.markercluster.layersupport.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet.markercluster.freezable@1.0.0/dist/leaflet.markercluster.freezable.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.4/nouislider.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.4/nouislider.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.5.0/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; overflow: hidden; }
    #map-container { position: relative; width: 100%; height: 100vh; }
    #map { width: 100%; height: 100%; }
    #slider-container { position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000; }
    #slider { width: 80%; max-width: 600px; height: 15px; margin: 20px auto; }
    .total-count-text { padding: 5px 10px; background-color: white; display: inline-block; }
    .btn-cluster { position: absolute; top: 50px; left: 10px; z-index: 1000; background: white; border: none; padding: 5px 10px; cursor: pointer; }
    .btn-cluster:hover { background: #ddd; }
  </style>
</head>
<body>
  <div id="map-container">
    <div id="map"></div>
    <div id="slider" ></div>
    <button class="btn-cluster" id="toggle-cluster">Toggle Clustering</button>
  </div>

  <script type="text/javascript">
    function isMobileDevice() { return window.innerWidth <= 800; }
    var initialZoom = isMobileDevice() ? 6 : 7;
    var map = L.map('map').setView([41.576, -99.634], initialZoom);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      maxZoom: 12,
    }).addTo(map);

    var YMH = new L.layerGroup(), NextSteps = new L.layerGroup(), WOW = new L.layerGroup(), PFW = new L.layerGroup();
    var PFWWL = new L.layerGroup(), GIP = new L.layerGroup(), CFW = new L.layerGroup(), PSC = new L.layerGroup();
    var RxFire = new L.layerGroup(), ChapterProject = new L.layerGroup(), HabitatShare = new L.layerGroup();
    var HabitatTour = new L.layerGroup(), TSP = new L.layerGroup(), BP = new L.layerGroup(), OFW = new L.layerGroup();
    var allMarkers = [], isClusteringEnabled = true;

    function createCustomIcon(className) {
      return L.divIcon({ className: 'custom-marker ' + className });
    }

    var programGroups = {
      "YMH": YMH, "Next Steps": NextSteps, "WOW": WOW, "PFW": PFW, "PFWWL": PFWWL, "GIP": GIP,
      "CFW": CFW, "PSC": PSC, "Rx Fire": RxFire, "Chapter Project": ChapterProject, "Habitat Share": HabitatShare,
      "Habitat Tour": HabitatTour, "TSP": TSP, "BP": BP, "OFW": OFW
    };

    var mcgLayerSupportGroup = L.markerClusterGroup.layerSupport({ maxClusterRadius: 50 });
    Object.values(programGroups).forEach(group => mcgLayerSupportGroup.checkIn(group));
    mcgLayerSupportGroup.addTo(map);

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRfQd3Get9tbbE-2bW6eY9BzOXtJFSQy4lS8_Nxj3ImRoTpbo-HcEhhVAjDrz17LeIGg41BIxVHkALE/pub?gid=2038937128&single=true&output=csv';
    fetch(csvUrl).then(response => response.text()).then(csvData => {
      csv2geojson.csv2geojson(csvData, { latfield: 'latitude', lonfield: 'longitude', delimiter: ',' }, (err, geojson) => {
        if (err) { console.error("Error converting CSV to GeoJSON:", err); return; }

        geojson.features.forEach(feature => {
          var { programref: program, title, count, year } = feature.properties;
          var latitude = feature.geometry.coordinates[1], longitude = feature.geometry.coordinates[0];
          var popupContent = `<b>Program:</b> ${title}<br/><b>Year:</b> ${year}<br/><b>Count:</b> ${count}`;
          var marker = L.marker([latitude, longitude], { icon: createCustomIcon('marker-icon-' + program.toLowerCase().replace(/\s+/g, '')) }).bindPopup(popupContent);
          marker.year = parseInt(year), marker.program = program, marker.count = parseInt(count, 10);
          allMarkers.push(marker);
          if (programGroups.hasOwnProperty(program)) marker.addTo(programGroups[program]);
        });

        var overlays = {
          '<span class="custom-marker marker-icon-ymh"></span> Youth Mentor Hunt': YMH,
          '<span class="custom-marker marker-icon-nextsteps"></span> Next Steps': NextSteps,
          '<span class="custom-marker marker-icon-wow"></span> Women on the Wing': WOW,
          '<span class="custom-marker marker-icon-pfw"></span> Pathway for Wildlife': PFW,
          '<span class="custom-marker marker-icon-pfwwl"></span> PFW Working Lands': PFWWL,
          '<span class="custom-marker marker-icon-gip"></span> Grasslands Improvement Program': GIP,
          '<span class="custom-marker marker-icon-cfw"></span> Corners for Wildlife': CFW,
          '<span class="custom-marker marker-icon-psc"></span> Pollinator Safety Corner': PSC,
          '<span class="custom-marker marker-icon-rxfire"></span> Prescribed Fire': RxFire,
          '<span class="custom-marker marker-icon-chapterproject"></span> Chapter Project': ChapterProject,
          '<span class="custom-marker marker-icon-habitatshare"></span> Habitat Share': HabitatShare,
          '<span class="custom-marker marker-icon-habitattour"></span> Habitat Tour': HabitatTour,
          '<span class="custom-marker marker-icon-tsp"></span> Technical Assistance': TSP,
          '<span class="custom-marker marker-icon-bp"></span> Berggren Plan': BP,
          '<span class="custom-marker marker-icon-ofw"></span> OFW Public Access': OFW
        };

        var control = L.control.layers(null, overlays, { collapsed: true }).addTo(map);
        var container = control.getContainer();
        container.style.bottom = '10px', container.style.top = '5px';
        var customText = L.DomUtil.create('div', 'custom-text');
        container.insertBefore(customText, container.firstChild);

        var totalCountText = L.DomUtil.create('div', 'total-count-text', customText);
        totalCountText.innerHTML = 'Total Habitat Projects: ' + allMarkers.reduce((acc, marker) => acc + marker.count, 0);
        
        var yearRange = allMarkers.reduce((range, marker) => {
          range.min = Math.min(range.min, marker.year), range.max = Math.max(range.max, marker.year);
          return range;
        }, { min: Infinity, max: -Infinity });

        var slider = document.getElementById('slider');
        noUiSlider.create(slider, { start: [yearRange.min, yearRange.max], connect: true, range: { 'min': yearRange.min, 'max': yearRange.max } });
        slider.noUiSlider.on('update', () => { updateMarkersAndTotalCount(); });

        var checkboxes = Array.from(document.querySelectorAll('.leaflet-control-layers-overlays input[type="checkbox"]'));
        checkboxes.forEach(checkbox => checkbox.addEventListener('change', () => { updateMarkersAndTotalCount(); }));

        function updateMarkersAndTotalCount() {
          var yearRange = slider.noUiSlider.get().map(Number);
          var selectedPrograms = checkboxes.filter(checkbox => checkbox.checked).map(checkbox => checkbox.nextSibling.textContent.trim());
          mcgLayerSupportGroup.clearLayers();
          var displayedMarkers = allMarkers.filter(marker => marker.year >= yearRange[0] && marker.year <= yearRange[1] && selectedPrograms.includes(marker.program));
          var totalHabitatCount = displayedMarkers.reduce((acc, marker) => acc + marker.count, 0);
          totalCountText.innerHTML = 'Total Habitat Projects: ' + totalHabitatCount;
          if (isClusteringEnabled) {
            displayedMarkers.forEach(marker => mcgLayerSupportGroup.addLayer(marker));
          } else {
            displayedMarkers.forEach(marker => map.addLayer(marker));
          }
        }
        updateMarkersAndTotalCount();
      });
    });

    document.getElementById('toggle-cluster').addEventListener('click', () => {
      isClusteringEnabled = !isClusteringEnabled;
      mcgLayerSupportGroup.clearLayers();
      allMarkers.forEach(marker => map.removeLayer(marker));
      updateMarkersAndTotalCount();
      var toggleButton = document.getElementById('toggle-cluster');
      toggleButton.innerText = isClusteringEnabled ? 'Disable Clustering' : 'Enable Clustering';
    });

    map.on('popupopen', () => { var container = document.querySelector('.leaflet-popup-content'); container.style.width = isMobileDevice() ? '100%' : 'auto'; });
  </script>
</body>
</html>
