<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nebraska Pheasants Forever Accomplishments</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.4/nouislider.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.5.0/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    #map-container {
      width: 100%;
      height: 85vh;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #slider-container {
      width: 100%;
      height: 15vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: white;
    }

    #slider {
      width: 80%;
      max-width: 600px;
    }

    .total-count-text {
      padding: 5px 10px;
      background-color: white;
      display: inline-block;
    }
  </style>
</head>

<body>
  <div id="map-container">
    <div id="map"></div>
  </div>
  <div id="slider-container">
    <div id="slider"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/csv2geojson@latest/csv2geojson.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster.layersupport@2.0.0/dist/leaflet.markercluster.layersupport.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.4/nouislider.min.js"></script>

  <script type="text/javascript">
    var map = L.map('map').setView([41.576, -99.634], 7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      maxZoom: 12,
    }).addTo(map);

    var markerCluster = L.markerClusterGroup();
    var YMH = new L.layerGroup();
    var NextSteps = new L.layerGroup();
    var WOW = new L.layerGroup();
    var PFW = new L.layerGroup();
    var PFWWL = new L.layerGroup();
    var GIP = new L.layerGroup();
    var CFW = new L.layerGroup();
    var PSC = new L.layerGroup();
    var RxFire = new L.layerGroup();
    var ChapterProject = new L.layerGroup();
    var HabitatShare = new L.layerGroup();
    var HabitatTour = new L.layerGroup();
    var TSP = new L.layerGroup();
    var BP = new L.layerGroup();
    var OFW = new L.layerGroup();

    var allMarkers = [];

    function createCustomIcon(className) {
      return L.divIcon({
        className: 'custom-marker ' + className,
      });
    }

    var programGroups = {
      "YMH": YMH,
      "Next Steps": NextSteps,
      "WOW": WOW,
      "PFW": PFW,
      "PFWWL": PFWWL,
      "GIP": GIP,
      "CFW": CFW,
      "PSC": PSC,
      "Rx Fire": RxFire,
      "Chapter Project": ChapterProject,
      "Habitat Share": HabitatShare,
      "Habitat Tour": HabitatTour,
      "TSP": TSP,
      "BP": BP,
      "OFW": OFW
    };

    var years = [2019, 2020, 2021, 2022, 2023, 2024];

    var mcgLayerSupportGroup = L.markerClusterGroup.layerSupport();
    Object.values(programGroups).forEach(function (group) {
      mcgLayerSupportGroup.checkIn(group);
    });

    mcgLayerSupportGroup.addTo(map);

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRfQd3Get9tbbE-2bW6eY9BzOXtJFSQy4lS8_Nxj3ImRoTpbo-HcEhhVAjDrz17LeIGg41BIxVHkALE/pub?gid=2038937128&single=true&output=csv';

    fetch(csvUrl)
      .then(response => response.text())
      .then(csvData => {
        csv2geojson.csv2geojson(csvData, {
          latfield: 'latitude',
          lonfield: 'longitude',
          delimiter: ',',
        }, function (err, geojson) {
          if (err) {
            console.error("Error converting CSV to GeoJSON:", err);
            return;
          }

          geojson.features.forEach(function (feature) {
            var program = feature.properties.programref;
            var title = feature.properties.title;
            var count = parseInt(feature.properties.count, 10);
            var year = parseInt(feature.properties.year, 10);
            var latitude = feature.geometry.coordinates[1];
            var longitude = feature.geometry.coordinates[0];

            var popupContent = `<b>Program:</b> ${title}<br/><b>Year:</b> ${year}<br/><b>Count:</b> ${count}`;
            
            var marker = L.marker([latitude, longitude], { icon: createCustomIcon('marker-icon-' + program.toLowerCase().replace(/\s+/g, '')) }).bindPopup(popupContent);

            marker.year = year;
            marker.program = program;
            marker.count = count;
            allMarkers.push(marker);

            if (programGroups.hasOwnProperty(program)) {
              marker.addTo(programGroups[program]);
            }

            markerCluster.addLayer(marker);
          });

          var overlays = {
            '<span class="custom-marker marker-icon-ymh"></span> Youth Mentor Hunt': YMH,
            '<span class="custom-marker marker-icon-nextsteps"></span> Next Steps': NextSteps,
            '<span class="custom-marker marker-icon-wow"></span> Women on the Wing': WOW,
            '<span class="custom-marker marker-icon-pfw"></span> Pathway for Wildlife': PFW,
            '<span class="custom-marker marker-icon-pfwwl"></span> PFW Working Lands': PFWWL,
            '<span class="custom-marker marker-icon-gip"></span> Grasslands Improvement Program': GIP,
            '<span class="custom-marker marker-icon-cfw"></span> Corners for Wildlife': CFW,
            '<span class="custom-marker marker-icon-psc"></span> Pollinator Safety Corner': PSC,
            '<span class="custom-marker marker-icon-rxfire"></span> Prescribed Fire': RxFire,
            '<span class="custom-marker marker-icon-chapterproject"></span> Chapter Project': ChapterProject,
            '<span class="custom-marker marker-icon-habitatshare"></span> Habitat Share': HabitatShare,
            '<span class="custom-marker marker-icon-habitattour"></span> Habitat Tour': HabitatTour,
            '<span class="custom-marker marker-icon-tsp"></span> Technical Assistance': TSP,
            '<span class="custom-marker marker-icon-bp"></span> Berggren Plan': BP,
            '<span class="custom-marker marker-icon-ofw"></span> OFW Public Access': OFW
          };

          var control = L.control.layers(null, overlays, { collapsed: true });
          control.addTo(map);

          // Add the program layers to the map by default
          map.addLayer(YMH);
          map.addLayer(NextSteps);
          map.addLayer(WOW);
          map.addLayer(PFW);
          map.addLayer(PFWWL);
          map.addLayer(GIP);
          map.addLayer(CFW);
          map.addLayer(PSC);
          map.addLayer(RxFire);
          map.addLayer(ChapterProject);
          map.addLayer(HabitatShare);
          map.addLayer(HabitatTour);
          map.addLayer(TSP);
          map.addLayer(BP);
          map.addLayer(OFW);

          var container = control.getContainer();
          container.style.bottom = '60px';
          container.style.right = '10px';
          container.style.position = 'absolute';
        });
      })
      .catch(error => console.error("Error fetching CSV data:", error));

    var sliderContainer = document.getElementById('slider-container');
    var slider = document.getElementById('slider');

    noUiSlider.create(slider, {
      start: [2019, 2024],
      connect: true,
      range: {
        'min': 2019,
        'max': 2024
      },
      step: 1,
      tooltips: false,
      format: {
        to: function (value) {
          return Math.round(value);
        },
        from: function (value) {
          return Number(value);
        }
      },
      pips: {
        mode: 'values',
        values: [2019, 2020, 2021, 2022, 2023, 2024],
        density: 20
      }
    });

    slider.noUiSlider.on('update', updateMarkers);

    function updateMarkers(values) {
      var minYear = parseInt(values[0]);
      var maxYear = parseInt(values[1]);

      markerCluster.clearLayers();
      Object.values(programGroups).forEach(function (group) {
        group.clearLayers();
      });

      var filteredCount = 0;

      allMarkers.forEach(function (marker) {
        var markerYear = parseInt(marker.year);
        if (markerYear >= minYear && markerYear <= maxYear) {
          if (map.hasLayer(programGroups[marker.program])) {
            filteredCount += marker.count;
            markerCluster.addLayer(marker);
            programGroups[marker.program].addLayer(marker);
          }
        }
      });

      document.getElementById('totalCount').textContent = filteredCount.toLocaleString();
      mcgLayerSupportGroup.checkIn(Object.values(programGroups));
    }
  </script>
</body>

</html>
